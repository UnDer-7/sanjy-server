##################
# BUILD ARGUMENTS
##################

# Define BUILD_MODE at global scope to be used in FROM instructions
ARG BUILD_MODE=full

##################
# BUILD STEP (FULL MODE)
##################
FROM container-registry.oracle.com/graalvm/native-image:25 AS build-full

RUN echo "========================================" && \
    echo "STAGE: build-full (GraalVM native compilation)" && \
    echo "========================================"

# Install build dependencies
RUN microdnf install -y findutils \
    && microdnf clean all

WORKDIR /build

# Copy all project files
COPY core core
COPY entrypoint entrypoint
COPY infrastructure infrastructure
COPY aggregate-report aggregate-report
COPY lombok.config .
COPY Makefile .
COPY pom.xml .
COPY mvnw .
COPY .mvn .mvn
COPY .env .env

# Build native image with environment variables loaded and move to standard location
RUN make build/graalvm \
    && mv infrastructure/target/*.graal /build/app.graal

##################
# BUILD STEP (LOCAL MODE)
##################
FROM alpine:3.23.3 AS build-local

RUN echo "========================================" && \
    echo "STAGE: build-local (using pre-built native binary)" && \
    echo "========================================"

WORKDIR /build

# Copy pre-built GraalVM native binary from local build
COPY infrastructure/target/*.graal ./app.graal

##################
# RELEASE STEP
##################
FROM build-${BUILD_MODE} AS build-selected

FROM alpine:3.23.3 AS release

RUN echo "========================================" && \
    echo "STAGE: release (final image)" && \
    echo "========================================"

WORKDIR /app

# Copy the native binary (either from build-full or build-local)
COPY --from=build-selected /build/*.graal ./app.graal

# Add executable permission to the binary
RUN chmod +x /app/app.graal \
    && apk upgrade --no-cache busybox busybox-binsh ssl_client \
    && apk add --no-cache gcompat

# Set up directories
ARG S_DATA_PATH=/app/data
RUN mkdir -p ${S_DATA_PATH}/logs/structured \
    && mkdir -p ${S_DATA_PATH}/logs/unstructured \
    && addgroup -g 1000 sanjy \
    && adduser -u 1000 -G sanjy -s /bin/sh -D sanjy \
    && chown -R sanjy:sanjy /app

USER sanjy

EXPOSE 8080

ENTRYPOINT ["./app.graal"]
