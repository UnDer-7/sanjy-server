name: Pull Request Pipeline

on:
  pull_request:
    types: [opened, labeled, synchronize, reopened]

jobs:
  version-validation:
    name: Version Validation
    runs-on: ubuntu-latest

    # Only run if PR has 'run-pipe' label
    if: contains(github.event.pull_request.labels.*.name, 'run-pipe')

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #v6.0.0

      - name: Setup GraalVM 25 (Oracle)
        uses: graalvm/setup-graalvm@eec48106e0bf45f2976c2ff0c3e22395cced8243 #v1.4.2
        with:
          java-version: '25'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'

      - name: Get current project version
        id: project-version
        run: |
          VERSION=$(make version)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current project version: $VERSION"

      - name: Get latest version tag
        id: latest-tag
        run: |
          # Fetch all version tags and get the latest one following semantic versioning
          LATEST_TAG=$(git ls-remote --tags https://github.com/UnDer-7/sanjy-server.git | \
            grep -oP 'refs/tags/\K[0-9]+\.[0-9]+\.[0-9]+$' | \
            sort -V | \
            tail -n 1)

          if [ -z "$LATEST_TAG" ]; then
            echo "latest_version=0.0.0" >> $GITHUB_OUTPUT
            echo "No existing version tags found. Starting from 0.0.0"
          else
            echo "latest_version=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "Latest published version: $LATEST_TAG"
          fi

      - name: Compare versions (Semantic Versioning)
        id: compare-versions
        run: |
          CURRENT_VERSION="${{ steps.project-version.outputs.version }}"
          LATEST_VERSION="${{ steps.latest-tag.outputs.latest_version }}"

          # Function to compare semantic versions
          compare_versions() {
            if [ "$1" = "$2" ]; then
              echo "equal"
              return
            fi

            # Split versions into major.minor.patch
            IFS='.' read -r -a current <<< "$1"
            IFS='.' read -r -a latest <<< "$2"

            # Compare major version
            if [ "${current[0]}" -gt "${latest[0]}" ]; then
              echo "greater"
              return
            elif [ "${current[0]}" -lt "${latest[0]}" ]; then
              echo "less"
              return
            fi

            # Compare minor version
            if [ "${current[1]}" -gt "${latest[1]}" ]; then
              echo "greater"
              return
            elif [ "${current[1]}" -lt "${latest[1]}" ]; then
              echo "less"
              return
            fi

            # Compare patch version
            if [ "${current[2]}" -gt "${latest[2]}" ]; then
              echo "greater"
              return
            elif [ "${current[2]}" -lt "${latest[2]}" ]; then
              echo "less"
              return
            fi

            echo "equal"
          }

          COMPARISON=$(compare_versions "$CURRENT_VERSION" "$LATEST_VERSION")
          echo "comparison=$COMPARISON" >> $GITHUB_OUTPUT
          echo "Version comparison: $CURRENT_VERSION vs $LATEST_VERSION = $COMPARISON"

      - name: Fail if version is not greater than latest
        if: steps.compare-versions.outputs.comparison != 'greater'
        run: |
          CURRENT_VERSION="${{ steps.project-version.outputs.version }}"
          LATEST_VERSION="${{ steps.latest-tag.outputs.latest_version }}"
          COMPARISON="${{ steps.compare-versions.outputs.comparison }}"

          echo "::error::Version validation failed!"
          echo ""

          if [ "$COMPARISON" = "equal" ]; then
            echo "‚ùå Current version $CURRENT_VERSION is equal to the latest published version."
          else
            echo "‚ùå Current version $CURRENT_VERSION is LESS than the latest published version $LATEST_VERSION."
          fi

          echo ""
          echo "üí° You must bump the version to be greater than $LATEST_VERSION"
          echo ""
          echo "Following Semantic Versioning:"
          echo "  - Patch release (bug fixes): make version/set $LATEST_VERSION ‚Üí increment patch (e.g., 1.0.0 ‚Üí 1.0.1)"
          echo "  - Minor release (new features): make version/set ‚Üí increment minor (e.g., 1.0.0 ‚Üí 1.1.0)"
          echo "  - Major release (breaking changes): make version/set ‚Üí increment major (e.g., 1.0.0 ‚Üí 2.0.0)"
          echo ""
          echo "After updating the version, commit and push the changes."
          exit 1

  coding-style:
    name: Coding Style
    runs-on: ubuntu-latest

    # Only run if version-validation job succeeded
    needs: version-validation
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #v6.0.0

      - name: Setup GraalVM 25 (Oracle)
        uses: graalvm/setup-graalvm@eec48106e0bf45f2976c2ff0c3e22395cced8243 #v1.4.2
        with:
          java-version: '25'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'

      - name: Verify GraalVM installation
        run: |
          echo "GRAALVM_HOME: $GRAALVM_HOME"
          echo "JAVA_HOME: $JAVA_HOME"
          java -version

      - name: Check code formatting
        id: format-check
        run: make fmt/check
        continue-on-error: true

      - name: Format check failed
        if: steps.format-check.outcome == 'failure'
        run: |
          echo "::error::Code formatting check failed!"
          echo ""
          echo "‚ùå To resolve this issue, format the code following the project guidelines."
          echo ""
          echo "üí° You can run the following command to automatically format the code:"
          echo "   make fmt"
          echo ""
          echo "After that, commit and push the formatted code."
          exit 1

      - name: Run lint check
        id: lint-check
        run: make lint
        continue-on-error: true

      - name: Lint check failed
        if: steps.lint-check.outcome == 'failure'
        run: |
          echo "::error::Lint check failed!"
          echo ""
          echo "‚ùå The project lint failed, some checkstyle rule was not followed."
          echo ""
          echo "üí° You can run the following command in your terminal to create an HTML report of the issues found:"
          echo "   make lint/report"
          echo ""
          echo "The report will show in detail which rules were violated."
          exit 1

  quality:
    name: Quality Analysis
    runs-on: ubuntu-latest

    # Only run if coding-style job succeeded
    needs: coding-style
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #v6.0.0
        with:
          fetch-depth: 0  # Fetch all history for SonarCloud analysis

      - name: Setup GraalVM 25 (Oracle)
        uses: graalvm/setup-graalvm@eec48106e0bf45f2976c2ff0c3e22395cced8243 #v1.4.2
        with:
          java-version: '25'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: 'maven'

      - name: Verify GraalVM installation
        run: |
          echo "GRAALVM_HOME: $GRAALVM_HOME"
          echo "JAVA_HOME: $JAVA_HOME"
          java -version

      - name: Run Snyk vulnerability scan
        id: snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: make snyk/test

      - name: Run tests
        id: test
        run: make test

      - name: Publish to SonarCloud
        if: steps.test.outcome == 'success'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: make sonar
